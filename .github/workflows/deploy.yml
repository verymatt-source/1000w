# .github/workflows/deploy.yml
# ------------------------------------------------------------
# 1. 基础信息配置
# ------------------------------------------------------------
name: 证券公司价格定时更新与部署

# ------------------------------------------------------------
# 2. 触发器配置 (何时运行)
# ------------------------------------------------------------
on:
  # 定时触发器 (Schedule Trigger)
  schedule:
    # 运行时间: 周一到周五，北京时间 09:00-16:00，每间隔30分钟运行一次。
    # 对应 UTC 时间: 01:30, 02:00, ..., 07:30, 08:00。
    - cron: '0,30 1-8 * * 1-5'
  
  # 手动触发器 (Manual Trigger)
  workflow_dispatch:

# ------------------------------------------------------------
# 3. 并发控制 (Concurrency)
# ------------------------------------------------------------
concurrency:
  cancel-in-progress: true
  group: ${{ github.workflow }}-${{ github.ref }}

# ------------------------------------------------------------
# 4. 权限配置 (Permissions)
# 【关键】部署到 GitHub Pages 必须授予这些权限
# contents: write 用于将更新后的 notification_log.json 提交回 Pages 分支。
# pages 和 id-token 用于 Pages 部署认证。
# ------------------------------------------------------------
permissions:
  contents: write     
  pages: write       
  id-token: write    

# ------------------------------------------------------------
# 5. 任务 (Jobs) 配置
# ------------------------------------------------------------
jobs:
  run_and_build:
    runs-on: ubuntu-latest
    
    # 设置环境变量 (Environment Variable)
    env:
      TZ: 'Asia/Shanghai' 
      # 【✅ 关键修正：添加此行，注入 Server酱 Secret Key ✅】
      # 变量名 SERVERCHAN_SCKEY 必须与 hs.py 中读取的变量名完全一致。
      SERVERCHAN_SCKEY: ${{ secrets.SERVERCHAN_SCKEY }} 
    
    steps:
      # 1. 检出代码 (Checkout)
      - name: 检出仓库代码
        uses: actions/checkout@v4

      # 2. 设置 Python 环境
      - name: 设置 Python 3.11 环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.11' 

      # 3. 安装依赖
      - name: 安装 Python 依赖 (requests)
        run: pip install requests
        
      # 【新增】4. 缓存通知日志文件 (实现防重发机制的文件持久化)
      - name: Cache Notification Log (Restore/Save)
        uses: actions/cache@v4
        with:
          # 缓存文件路径：脚本期望在根目录读取和写入
          path: notification_log.json
          # 缓存键：使用 os 和脚本文件哈希，确保在脚本逻辑变更后重新开始计数
          key: ${{ runner.os }}-notification-log-${{ hashFiles('hs.py') }}
          # 恢复键：如果精确键不匹配，尝试恢复上一次的日志
          restore-keys: |
            ${{ runner.os }}-notification-log-

      # 5. 运行脚本并构建站点目录
      - name: 运行价格脚本并构建 _site 目录
        run: |
          # 1. 创建 Pages 标准的输出目录 _site
          mkdir _site
          # 2. 运行 Python 脚本。脚本运行时会读/写 notification_log.json
          python -u hs.py
          # 3. 移动并重命名文件。
          mv index_price.html _site/index.html 
          # 4. 【关键修正】：将日志文件复制（cp）到 _site 目录。
          #    必须使用 cp 而非 mv，以保留根目录的日志文件供上一步的 Cache Action 自动保存。
          if [ -f notification_log.json ]; then
            cp notification_log.json _site/ # 已修正为 cp
          fi
          
      # 6. 🛠 调试步骤：检查 _site 目录内容
      - name: 检查 _site 目录内容
        run: ls -R _site/
        
      # ------------------------------------------------------------
      # 【部署修复】上传部署文件 (Artifacts)，解决 "No artifacts named..." 错误
      # ------------------------------------------------------------
      - name: 配置 GitHub Pages 部署
        uses: actions/configure-pages@v5

      - name: 上传待部署的文件 (Pages Artifact)
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site' # 上传 _site 目录下的所有内容
          
      # ------------------------------------------------------------

  # ------------------------------------------------------------
  # 7. 部署到 GitHub Pages (Deployment)
  # ------------------------------------------------------------
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    # 部署任务依赖于 run_and_build 任务
    needs: run_and_build 
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
