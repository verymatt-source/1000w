<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supabase æ•°æ®è¯»å–ä¸ç¼–è¾‘ (Munger)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f4f7f6; }
        h1 { color: #1e88e5; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: white; box-shadow: 0 4px 8px rgba(0 0 0 / 10%); }
        th, td { border: 1px solid #e0e0e0; padding: 12px 15px; text-align: left; }
        th { background-color: #1e88e5; color: white; font-weight: bold; text-transform: uppercase; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        
        /* é’ˆå¯¹å¯ç¼–è¾‘å­—æ®µçš„æ ·å¼ */
        td[data-is-editable="true"] { cursor: pointer; }
        td[contenteditable="true"]:focus { outline: 2px solid #ff9800; background-color: #fffde7; }
        
        .loading { text-align: center; color: #555; padding: 20px; font-style: italic; }
        .success { color: #4caf50; font-weight: bold; margin-top: 10px; }
        .error { color: #e53935; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

    <h1>ğŸ“ Munger è¡¨æ ¼æ•°æ® (åŒå‡»å•å…ƒæ ¼ç¼–è¾‘)</h1>

    <div id="data-container">
        <p class="loading">æ­£åœ¨è¿æ¥ Supabase å¹¶åŠ è½½æ•°æ®...</p>
    </div>
    
    <p id="message-status"></p>

    <script>
        // =======================================================================
        // ã€é…ç½®ä¿¡æ¯ã€‘è¯·æ ¹æ®æ‚¨çš„é¡¹ç›®ä¿¡æ¯è¿›è¡Œç¡®è®¤å’Œæ›¿æ¢
        // =======================================================================
        const SUPABASE_URL = 'https://qburustwmcjpnilofjsi.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFidXJ1c3R3bWNqcG5pbG9manNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MTI4MjUsImV4cCI6MjA3OTM4ODgyNX0.mzJN1k0ogNnr9kpqtandH_OH9nHIIeNrde1uac4JEdc'; 
        const TABLE_NAME = 'Munger'; 
        
        // ã€å­—æ®µé™åˆ¶ã€‘
        const UNEDITABLE_FIELDS = [
            'name', 'code', 'current_price', 
            'updated_at', 'ratio' 
        ]; 
        
        // ğŸš¨ æ–°å¢ï¼šè¦ä»è¡¨æ ¼ä¸­éšè—çš„å­—æ®µï¼ˆID å’Œ FREQUENCYï¼‰
        const FIELDS_TO_HIDE = ['id', 'frequency', 'created_at'];
        
        // ã€æ’åºé…ç½®ã€‘
        const SORT_FIELD = 'ratio'; // é»˜è®¤æ’åºå­—æ®µ
        const SORT_DIRECTION = 'asc'; // é»˜è®¤æ’åºæ–¹å‘ï¼š'asc'ï¼ˆå‡åºï¼‰æˆ– 'desc'ï¼ˆé™åºï¼‰
        // =======================================================================
        
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        const dataContainer = document.getElementById('data-container');
        const statusMessage = document.getElementById('message-status');

        // çŠ¶æ€æ¶ˆæ¯æ˜¾ç¤ºå‡½æ•°
        function showStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.className = isError ? 'error' : 'success';
            setTimeout(() => {
                statusMessage.textContent = '';
                statusMessage.className = '';
            }, 3000);
        }

        // --- æ•°æ®æ ¼å¼åŒ–è¾…åŠ©å‡½æ•° ---
        function formatDateTime(isoString) {
            if (!isoString) return '-';
            try { 
                // åˆ†ç¦»æ—¥æœŸå’Œæ—¶é—´éƒ¨åˆ†
                const [date, time] = isoString.split('T');
                // æå–æ—¶é—´éƒ¨åˆ†çš„æ—¶åˆ†ç§’ï¼ˆå»æ‰æ¯«ç§’å’Œæ—¶åŒºä¿¡æ¯ï¼‰
                const timePart = time ? time.substring(0, 8) : '';
                // è¿”å›å®Œæ•´çš„å¹´æœˆæ—¥æ—¶åˆ†ç§’æ ¼å¼
                return timePart ? `${date} ${timePart}` : date;
            } catch (e) { return isoString; }
        }
        function formatPrice(value) {
            if (value === null || isNaN(value)) return '-';
            return parseFloat(value).toFixed(2);
        }
        function formatRatio(value) {
            if (value === null || isNaN(value)) return '-';
            return (parseFloat(value) * 100).toFixed(2) + '%';
        }

        // -----------------------------------------------------------------------
        // å‡½æ•°ä¸€ï¼šä» Supabase è¯»å–æ•°æ®å¹¶æ¸²æŸ“è¡¨æ ¼
        // -----------------------------------------------------------------------
        async function fetchAndDisplayData() {
            dataContainer.innerHTML = '<p class="loading">æ­£åœ¨ä» Supabase è¯»å–æ•°æ®...</p>';
            
            try {
                // 1. ä»æ•°æ®åº“è·å–æ‰€æœ‰æ•°æ®
                let { data: rows, error } = await client
                    .from(TABLE_NAME)
                    .select('*')
                    .order(SORT_FIELD, { ascending: SORT_DIRECTION === 'asc' }); 

                if (error) {
                    console.error('Supabase é”™è¯¯:', error);
                    dataContainer.innerHTML = `<p class="error">æ•°æ®åŠ è½½å¤±è´¥ï¼é”™è¯¯ä¿¡æ¯ï¼š${error.message}</p>`;
                    showStatus('è¯»å–æ•°æ®å¤±è´¥', true);
                    return;
                }

                if (!rows || rows.length === 0) {
                     dataContainer.innerHTML = '<p class="loading">æ•°æ®åº“ä¸­æ²¡æœ‰æ‰¾åˆ°æ•°æ®ã€‚</p>';
                     return;
                }

                // 2. åŠ¨æ€æ„å»º HTML è¡¨æ ¼
                let htmlContent = '<table><thead><tr>';
                
                // è·å–æ‰€æœ‰å­—æ®µå
                const allFields = Object.keys(rows[0]);
                
                // å…³é”®æ”¹åŠ¨ï¼šè¿‡æ»¤æ‰è¦éšè—çš„å­—æ®µï¼Œå¾—åˆ°æœ€ç»ˆè¦æ˜¾ç¤ºçš„å­—æ®µåˆ—è¡¨
                let fieldsToDisplay = allFields.filter(field => !FIELDS_TO_HIDE.includes(field));
                
                // ç¡®ä¿RATIOå­—æ®µåœ¨NOTEå­—æ®µå‰é¢
                const ratioIndex = fieldsToDisplay.indexOf('ratio');
                const noteIndex = fieldsToDisplay.indexOf('note');
                
                // å¦‚æœratioåœ¨noteä¹‹åï¼Œåˆ™è°ƒæ•´é¡ºåº
                if (ratioIndex > -1 && noteIndex > -1 && ratioIndex > noteIndex) {
                    // å…ˆç§»é™¤ratio
                    fieldsToDisplay.splice(ratioIndex, 1);
                    // ç„¶ååœ¨noteå‰é¢æ’å…¥ratio
                    fieldsToDisplay.splice(noteIndex, 0, 'ratio');
                }
                
                // æ„å»ºè¡¨å¤´ (ä½¿ç”¨ fieldsToDisplay)
                htmlContent += fieldsToDisplay.map(field => `<th>${field.toUpperCase().replace('_', ' ')}</th>`).join('');
                htmlContent += '</tr></thead><tbody>';
                
                // æ„å»ºæ•°æ®è¡Œ
                htmlContent += rows.map(row => {
                    // éå†æ‰€æœ‰è¦æ˜¾ç¤ºçš„å­—æ®µ
                    const rowCells = fieldsToDisplay.map(field => {
                        const fieldName = field.toLowerCase();
                        const rawValue = row[field];
                        let displayValue = rawValue === null ? '-' : rawValue; 
                        let isEditable = !UNEDITABLE_FIELDS.includes(fieldName);
                        
                        // åº”ç”¨æ ¼å¼åŒ–è§„åˆ™
                        if (fieldName === 'created_at' || fieldName === 'updated_at') {
                            displayValue = formatDateTime(rawValue);
                        } else if (fieldName === 'target_price' || fieldName === 'current_price') {
                            displayValue = formatPrice(rawValue);
                        } else if (fieldName === 'ratio') {
                            displayValue = formatRatio(rawValue);
                        }
                        
                        // åˆå§‹ contenteditable="false"
                        return `<td 
                            data-id="${row.id}" 
                            data-field="${fieldName}" 
                            data-original-value="${rawValue}"
                            data-is-editable="${isEditable ? 'true' : 'false'}" 
                            contenteditable="false" 
                        >${displayValue}</td>`;
                    }).join('');
                    return `<tr>${rowCells}</tr>`;
                }).join('');
                
                htmlContent += '</tbody></table>';
                dataContainer.innerHTML = htmlContent;
                showStatus('æ•°æ®åŠ è½½æˆåŠŸ');
                
            } catch (e) {
                console.error('JS è¿è¡Œæ—¶é”™è¯¯:', e);
                dataContainer.innerHTML = `<p class="error">é¡µé¢åˆå§‹åŒ–å¤±è´¥ï¼è¯·æ£€æŸ¥æ§åˆ¶å°é”™è¯¯ã€‚</p>`;
            }
        }

        // -----------------------------------------------------------------------
        // å‡½æ•°äºŒï¼šåŒå‡»å¯ç”¨ç¼–è¾‘ (ä¿æŒä¸å˜)
        // -----------------------------------------------------------------------
        function enableEdit(event) {
            const target = event.target;
            // æ£€æŸ¥ç›®æ ‡æ˜¯å¦ä¸ºtdå…ƒç´ ï¼Œä¸”è¢«æ ‡è®°ä¸ºå¯ç¼–è¾‘
            if (target.tagName === 'TD' && target.dataset.isEditable === 'true') {
                // å¯ç”¨ç¼–è¾‘å¹¶ä½¿å…¶è·å¾—ç„¦ç‚¹
                target.contentEditable = 'true';
                target.focus();
            }
        }
        
        // -----------------------------------------------------------------------
        // å‡½æ•°ä¸‰ï¼šå¤„ç†å•å…ƒæ ¼å†…å®¹ä¿®æ”¹ï¼ˆå¤±å»ç„¦ç‚¹ä¿å­˜æ•°æ®ï¼‰(ä¿æŒä¸å˜)
        // -----------------------------------------------------------------------
        async function handleUpdate(event) {
            const target = event.target;
            
            if (target.tagName !== 'TD' || target.dataset.isEditable !== 'true') {
                return; 
            }
            
            const rowId = target.dataset.id;
            const fieldName = target.dataset.field;
            const originalValue = target.dataset.originalValue;
            
            // 1. åœ¨ä¿å­˜å‰ç«‹å³ç¦ç”¨ç¼–è¾‘æ¨¡å¼
            target.contentEditable = 'false';
            
            // 2. è·å–å¹¶å¤„ç†æ–°å€¼
            let newValue = target.textContent.trim(); 
            let rawNewValue = newValue;

            if (fieldName === 'target_price') {
                rawNewValue = rawNewValue.replace(/[^0-9.]/g, ''); 
            }
            
            // 3. æ£€æŸ¥æ˜¯å¦æœ‰å®è´¨æ€§å˜åŒ–
            let isChanged = true;
            if (String(rawNewValue) === String(originalValue)) {
                 isChanged = false;
            } else if (!isNaN(parseFloat(rawNewValue)) && !isNaN(parseFloat(originalValue))) {
                 if (parseFloat(rawNewValue).toFixed(2) === parseFloat(originalValue).toFixed(2)) {
                    isChanged = false;
                 }
            }
            
            if (!isChanged) {
                target.textContent = fieldName === 'target_price' ? formatPrice(originalValue) : originalValue;
                return;
            }

            showStatus(`æ­£åœ¨æ›´æ–° ${fieldName} å­—æ®µ...`);

            // 4. æ‰§è¡Œæ›´æ–°
            const { error } = await client
                .from(TABLE_NAME)
                .update({ [fieldName]: rawNewValue }) 
                .eq('id', rowId); // æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨äº† data-id å±æ€§æ¥è·å– IDï¼Œå³ä½¿ ID è¢«éšè—äº†ï¼Œå®ƒä»ç„¶å­˜åœ¨äº DOM å±æ€§ä¸­
            
            if (error) {
                console.error('æ›´æ–°æ•°æ®å¤±è´¥:', error);
                showStatus(`æ›´æ–°å¤±è´¥: ${error.message} (æ£€æŸ¥ RLS UPDATE ç­–ç•¥)`, true);
                target.textContent = fieldName === 'target_price' ? formatPrice(originalValue) : originalValue;
                return;
            }
            
            // 5. æ›´æ–°æˆåŠŸ
            target.dataset.originalValue = rawNewValue;
            target.textContent = fieldName === 'target_price' ? formatPrice(rawNewValue) : rawNewValue;
            
            showStatus('æ›´æ–°æˆåŠŸ');
        }

        // é¡µé¢åŠ è½½å®Œæˆåè°ƒç”¨ä¸»å‡½æ•°å¹¶è®¾ç½®äº‹ä»¶ç›‘å¬
        document.addEventListener('DOMContentLoaded', () => {
            fetchAndDisplayData(); 
            
            // 1. åŒå‡»å¯ç”¨ç¼–è¾‘
            dataContainer.addEventListener('dblclick', enableEdit); 

            // 2. å¤±å»ç„¦ç‚¹ä¿å­˜æ•°æ®
            dataContainer.addEventListener('blur', handleUpdate, true); 
        });

    </script>
</body>
</html>
