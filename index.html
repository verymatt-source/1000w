<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="refresh" content="3600">
    <title>Supabase æ•°æ®åªè¯»å±•ç¤º (Munger)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="quotes.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f4f7f6; }
        h1 { color: #1e88e5; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background-color: white; box-shadow: 0 4px 8px rgba(0 0 0 / 10%); }
        th, td { border: 1px solid #e0e0e0; padding: 12px 15px; text-align: left; }
        th { background-color: #1e88e5; color: white; font-weight: bold; text-transform: uppercase; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        
        .loading { text-align: center; color: #555; padding: 20px; font-style: italic; }
        .success { color: #4caf50; font-weight: bold; margin-top: 10px; }
        .error { color: #e53935; font-weight: bold; margin-top: 10px; }
        
        /* è¯­å½•æ¡†æ ·å¼ */
        .quote-container { 
            background-color: #fff9c4; 
            border: 1px solid #e0e0e0; 
            border-radius: 8px; 
            padding: 20px; 
            margin: 20px 0; 
            box-shadow: 0 4px 8px rgba(0 0 0 / 10%); 
            max-width: 800px; 
            margin-left: auto; 
            margin-right: auto; 
        }
        .quote-text { 
            font-size: 18px; 
            font-style: italic; 
            color: #856404; 
            margin-bottom: 10px; 
            line-height: 1.6; 
        }
        .quote-author { 
            font-size: 15px;
            text-align: right; 
            font-weight: bold; 
            color: #b83838; 
        }
    </style>
</head>
<body>

    <h1>ğŸ“ Munger è¡¨æ ¼æ•°æ® (åªè¯»)</h1>
    
    <!-- è¯­å½•æ˜¾ç¤ºåŒºåŸŸ -->
    <div class="quote-container">
        <div id="quote-text" class="quote-text">æ­£åœ¨åŠ è½½è¯­å½•...</div>
        <div id="quote-author" class="quote-author"></div>
    </div>

    <div id="data-container">
        <p class="loading">æ­£åœ¨è¿æ¥ Supabase å¹¶åŠ è½½æ•°æ®...</p>
    </div>
    
    <p id="message-status"></p>

    <script>
        // =======================================================================
        // ã€é…ç½®ä¿¡æ¯ã€‘
        // =======================================================================
        const SUPABASE_URL = 'https://qburustwmcjpnilofjsi.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFidXJ1c3R3bWNqcG5pbG9manNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MTI4MjUsImV4cCI6MjA3OTM4ODgyNX0.mzJN1k0ogNnr9kpqtandH_OH9nHIIeNrde1uac4JEdc'; 
        const TABLE_NAME = 'Munger'; 
        
        // ã€æ˜¾ç¤ºé¡ºåºé…ç½®ã€‘ - æ–°å¢ï¼Œå®šä¹‰ç²¾ç¡®çš„åˆ—é¡ºåº
        const DISPLAY_ORDER = [
            'name', 
            'code', 
            'target_price', 
            'current_price', 
            'ratio', 
            'note', 
            'updated_at'
        ];
        
        // ã€æ’åºé…ç½®ã€‘
        const SORT_FIELD = 'ratio'; // é»˜è®¤æ’åºå­—æ®µ
        const SORT_DIRECTION = 'asc'; // é»˜è®¤æ’åºæ–¹å‘ï¼š'asc'ï¼ˆå‡åºï¼‰æˆ– 'desc'ï¼ˆé™åºï¼‰
        // =======================================================================
        
        const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        const dataContainer = document.getElementById('data-container');
        const statusMessage = document.getElementById('message-status');
        const quoteTextElement = document.getElementById('quote-text');
        const quoteAuthorElement = document.getElementById('quote-author');
        
        // ä»quotesDataä¸­éšæœºè¯»å–å¹¶æ˜¾ç¤ºè¯­å½•çš„å‡½æ•°
        function loadRandomQuote() {
            try {
                // æ£€æŸ¥quotesDataæ˜¯å¦å­˜åœ¨ä¸”æ˜¯æ•°ç»„
                if (!window.quotesData || !Array.isArray(window.quotesData) || window.quotesData.length === 0) {
                    quoteTextElement.textContent = 'æ— æ³•åŠ è½½è¯­å½•æ•°æ®';
                    quoteAuthorElement.textContent = '';
                    console.warn('quotesDataä¸å¯ç”¨æˆ–ä¸ºç©º');
                    return;
                }
                
                // éšæœºé€‰æ‹©ä¸€æ¡è¯­å½•
                const randomIndex = Math.floor(Math.random() * window.quotesData.length);
                const selectedQuote = window.quotesData[randomIndex];
                
                // æ›´æ–°DOMå…ƒç´ 
                if (selectedQuote && selectedQuote.quote) {
                    quoteTextElement.textContent = selectedQuote.quote;
                    quoteAuthorElement.textContent = selectedQuote.author ? `- ${selectedQuote.author}` : '';
                } else {
                    quoteTextElement.textContent = 'è¯­å½•æ ¼å¼ä¸æ­£ç¡®';
                    quoteAuthorElement.textContent = '';
                }
            } catch (error) {
                console.error('åŠ è½½è¯­å½•æ—¶å‡ºé”™:', error);
                quoteTextElement.textContent = 'åŠ è½½è¯­å½•æ—¶å‡ºé”™';
                quoteAuthorElement.textContent = '';
            }
        }

        // çŠ¶æ€æ¶ˆæ¯æ˜¾ç¤ºå‡½æ•°
        function showStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.className = isError ? 'error' : 'success';
            setTimeout(() => {
                statusMessage.textContent = '';
                statusMessage.className = '';
            }, 3000);
        }

        // --- æ•°æ®æ ¼å¼åŒ–è¾…åŠ©å‡½æ•° ---
        function formatDateTime(isoString) {
            if (!isoString) return '-';
            try { 
                const [date, time] = isoString.split('T');
                const timePart = time ? time.substring(0, 8) : '';
                return timePart ? `${date} ${timePart}` : date;
            } catch (e) { return isoString; }
        }
        function formatPrice(value) {
            if (value === null || isNaN(value)) return '-';
            return parseFloat(value).toFixed(2);
        }
        function formatRatio(value) {
            if (value === null || isNaN(value)) return '-';
            return (parseFloat(value) * 100).toFixed(2) + '%';
        }

        // -----------------------------------------------------------------------
        // å‡½æ•°ä¸€ï¼šä» Supabase è¯»å–æ•°æ®å¹¶æ¸²æŸ“è¡¨æ ¼
        // -----------------------------------------------------------------------
        async function fetchAndDisplayData() {
            dataContainer.innerHTML = '<p class="loading">æ­£åœ¨ä» Supabase è¯»å–æ•°æ®...</p>';
            
            try {
                // 1. ä»æ•°æ®åº“è·å–æ‰€æœ‰æ•°æ®
                let { data: rows, error } = await client
                    .from(TABLE_NAME)
                    .select('*')
                    .order(SORT_FIELD, { ascending: SORT_DIRECTION === 'asc' }); 

                if (error) {
                    console.error('Supabase é”™è¯¯:', error);
                    dataContainer.innerHTML = `<p class="error">æ•°æ®åŠ è½½å¤±è´¥ï¼é”™è¯¯ä¿¡æ¯ï¼š${error.message}</p>`;
                    showStatus('è¯»å–æ•°æ®å¤±è´¥', true);
                    return;
                }

                if (!rows || rows.length === 0) {
                     dataContainer.innerHTML = '<p class="loading">æ•°æ®åº“ä¸­æ²¡æœ‰æ‰¾åˆ°æ•°æ®ã€‚</p>';
                     return;
                }

                // 2. åŠ¨æ€æ„å»º HTML è¡¨æ ¼
                let htmlContent = '<table><thead><tr>';
                
                // 1. æ„å»ºè¡¨å¤´ (ä½¿ç”¨ DISPLAY_ORDER)
                htmlContent += DISPLAY_ORDER.map(field => `<th>${field.toUpperCase().replace('_', ' ')}</th>`).join('');
                htmlContent += '</tr></thead><tbody>';
                
                // 2. æ„å»ºæ•°æ®è¡Œ
                htmlContent += rows.map(row => {
                    // éå† DISPLAY_ORDER
                    const rowCells = DISPLAY_ORDER.map(field => {
                        const fieldName = field.toLowerCase();
                        const rawValue = row[field];
                        let displayValue = rawValue === null ? '-' : rawValue;
                        
                        // åº”ç”¨æ ¼å¼åŒ–è§„åˆ™
                        if (fieldName === 'updated_at') {
                            displayValue = formatDateTime(rawValue);
                        } else if (fieldName === 'target_price' || fieldName === 'current_price') {
                            displayValue = formatPrice(rawValue);
                        } else if (fieldName === 'ratio') {
                            displayValue = formatRatio(rawValue);
                        }
                        
                        return `<td>${displayValue}</td>`;
                    }).join('');
                    return `<tr>${rowCells}</tr>`;
                }).join('');
                
                htmlContent += '</tbody></table>';
                dataContainer.innerHTML = htmlContent;
                showStatus('æ•°æ®åŠ è½½æˆåŠŸ');
                
            } catch (e) {
                console.error('JS è¿è¡Œæ—¶é”™è¯¯:', e);
                dataContainer.innerHTML = `<p class="error">é¡µé¢åˆå§‹åŒ–å¤±è´¥ï¼è¯·æ£€æŸ¥æ§åˆ¶å°é”™è¯¯ã€‚</p>`;
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåè°ƒç”¨ä¸»å‡½æ•°å’Œè¯­å½•åŠ è½½å‡½æ•°
        document.addEventListener('DOMContentLoaded', () => {
            fetchAndDisplayData(); 
            loadRandomQuote(); // åŠ è½½éšæœºè¯­å½•
        });

    </script>
</body>
</html>